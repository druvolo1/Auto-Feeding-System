<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Settings - Flow Meter Monitor</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/style.css">
    <link rel="manifest" href="/static/manifest.json">
    <style>
        .calibration-row {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        .calibration-row label {
            width: 120px;
            margin-right: 10px;
        }
        .calibration-row input {
            flex: 1;
        }
        .relay-port-select {
            width: 100px;
        }
    </style>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        loadSettings();

        // Handle USB assignment form submit
        const valveForm = document.getElementById('valve-relay-form');
        if (valveForm) {
            valveForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const device = document.getElementById('valve-relay-device')?.value;
                if (device) {
                    saveUsbAssignment('valve_relay', device);
                } else {
                    alert('Please select a device.');
                }
            });
        }

        // Handle relay ports form submit
        const relayPortForm = document.getElementById('relay-port-form');
        if (relayPortForm) {
            relayPortForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const feedPort = parseInt(document.getElementById('feed-water-relay-port')?.value, 10);
                const freshPort = parseInt(document.getElementById('fresh-water-relay-port')?.value, 10);
                if (!isNaN(feedPort) && !isNaN(freshPort)) {
                    fetch('/api/settings', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ relay_ports: { feed_water: feedPort, fresh_water: freshPort } })
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.status === 'success') {
                                alert('Relay ports saved successfully.');
                                loadSettings();
                            } else {
                                alert('Failed to save relay ports: ' + data.error);
                            }
                        })
                        .catch(error => console.error('Error saving relay ports:', error));
                } else {
                    alert('Please select valid ports.');
                }
            });
        }
    });

    function loadSettings() {
        fetch('/api/settings')
            .then(response => response.json())
            .then(data => {
                const plantsList = document.getElementById('additional-plants-list');
                if (plantsList) {
                    plantsList.innerHTML = '';
                    data.additional_plants.forEach((plant, index) => {
                        const div = document.createElement('div');
                        div.className = 'valve-rename-cell';
                        div.innerHTML = `
                            <input type="text" value="${plant}" disabled>
                            <button class="small-btn secondary-btn" onclick="removePlant(${index})">Remove</button>
                        `;
                        plantsList.appendChild(div);
                    });
                }

                data.calibration_factors = data.calibration_factors || {};
                const freshCal = document.getElementById('fresh-cal');
                if (freshCal) freshCal.value = data.calibration_factors.fresh || 28.390575;
                const feedCal = document.getElementById('feed-cal');
                if (feedCal) feedCal.value = data.calibration_factors.feed || 28.390575;
                const drainCal = document.getElementById('drain-cal');
                if (drainCal) drainCal.value = data.calibration_factors.drain || 28.390575;

                // Load relay ports
                const relayPorts = data.relay_ports || { feed_water: 1, fresh_water: 2 };
                const feedPortEl = document.getElementById('feed-water-relay-port');
                if (feedPortEl) feedPortEl.value = relayPorts.feed_water;
                const freshPortEl = document.getElementById('fresh-water-relay-port');
                if (freshPortEl) freshPortEl.value = relayPorts.fresh_water;

                // Load and populate USB devices with pre-selection
                data.usb_roles = data.usb_roles || {};
                populateUsbDevices(data.usb_roles.valve_relay);
            })
            .catch(error => console.error('Error loading settings:', error));
    }

    function populateUsbDevices(currentDevice) {
        fetch('/api/settings/usb_devices')
            .then(response => response.json())
            .then(devices => {
                const valveDevSelect = document.getElementById('valve-relay-device');
                if (valveDevSelect) {
                    valveDevSelect.innerHTML = '<option value="">Select a device</option>';
                    devices.forEach(dev => {
                        const option = document.createElement('option');
                        option.value = dev.device;
                        option.textContent = dev.device;
                        if (option.value === currentDevice) {
                            option.selected = true;
                        }
                        valveDevSelect.appendChild(option);
                    });
                }
            })
            .catch(error => console.error('Error fetching USB devices:', error));
    }

    function addAdditionalPlant() {
        const newIp = document.getElementById('new-plant-ip')?.value.trim();
        if (!newIp) {
            alert('Please enter a valid IP or DNS.');
            return;
        }

        fetch('/api/settings', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ additional_plants: [newIp] })  // Send as array to append
        })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    document.getElementById('new-plant-ip').value = '';
                    loadSettings();
                } else {
                    alert('Failed to add plant: ' + data.error);
                }
            })
            .catch(error => console.error('Error adding plant:', error));
    }

    function removePlant(index) {
        fetch('/api/settings/remove_plant', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ index: index })
        })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    loadSettings();
                } else {
                    alert('Failed to remove plant: ' + data.error);
                }
            })
            .catch(error => console.error('Error removing plant:', error));
    }

    function saveCalibrationFactors() {
        const fresh = parseFloat(document.getElementById('fresh-cal')?.value);
        const feed = parseFloat(document.getElementById('feed-cal')?.value);
        const drain = parseFloat(document.getElementById('drain-cal')?.value);

        if (isNaN(fresh) || isNaN(feed) || isNaN(drain)) {
            alert('Please enter valid numbers for all calibration factors.');
            return;
        }

        fetch('/api/settings', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ calibration_factors: { fresh, feed, drain } })
        })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert('Calibration factors saved successfully.');
                    loadSettings();  // Reload to confirm
                } else {
                    alert('Failed to save calibration factors: ' + data.error);
                }
            })
            .catch(error => console.error('Error saving calibration factors:', error));
    }

    function saveUsbAssignment(role, device) {
        fetch("/api/settings/assign_usb", {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ role, device })
        })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert(`${role} assigned successfully.`);
                    loadSettings();  // Refresh after save
                } else {
                    alert(`Failed to assign ${role}: ${data.error}`);
                }
            })
            .catch(error => console.error(`Error assigning ${role}:`, error));
    }

    function turnOnRelay(relayId) {
        fetch(`/api/valve_relay/${relayId}/on`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert(`Relay ${relayId} turned ON.`);
                } else {
                    alert(`Failed to turn on relay ${relayId}: ${data.error}`);
                }
            })
            .catch(error => console.error(`Error turning on relay ${relayId}:`, error));
    }

    function turnOffRelay(relayId) {
        fetch(`/api/valve_relay/${relayId}/off`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert(`Relay ${relayId} turned OFF.`);
                } else {
                    alert(`Failed to turn off relay ${relayId}: ${data.error}`);
                }
            })
            .catch(error => console.error(`Error turning off relay ${relayId}:`, error));
    }
</script>
</head>
<body>
    <nav>
        <ul>
            <li><a href="/" class="active">Home</a></li>
            <li><a href="/settings" class="active">Settings</a></li>
            <li><a href="/debug" class="active">Debug</a></li>
            <li><a href="/logs">Logs</a></li>
        </ul>
    </nav>

    <main>
        <h1>Settings</h1>
        <p class="subtitle">Configure your flow meter monitor.</p>

        <div class="data-container">
            <h3>Plants to feed</h3>
            <div id="additional-plants-list">
                <!-- Populated by JS -->
            </div>
            <p>New IP / DNS:</p>
            <div class="valve-rename-cell">
                <input type="text" id="new-plant-ip" placeholder="e.g., 192.168.1.100 or plant2.local">
                <button class="small-btn" onclick="addAdditionalPlant()">+ Add</button>
            </div>
        </div>

        <div class="data-container">
            <h3>Flow Meter Calibration (pulses per gallon)</h3>
            <div class="calibration-row">
                <label>Fresh Water:</label>
                <input type="number" id="fresh-cal" step="0.001">
            </div>
            <div class="calibration-row">
                <label>Feed Water:</label>
                <input type="number" id="feed-cal" step="0.001">
            </div>
            <div class="calibration-row">
                <label>Drain:</label>
                <input type="number" id="drain-cal" step="0.001">
            </div>
            <button class="small-btn" onclick="saveCalibrationFactors()">Save Calibration Factors</button>
        </div>

        <!-- Valve Relay Module Form -->
        <div class="data-container">
            <h3>Valve Relay Module</h3>
            <form id="valve-relay-form">
                <label for="valve-relay-device">Valve Relay Module:</label>
                <select id="valve-relay-device" name="valve-relay-device">
                    <option value="">Select a device</option>
                </select>
                <button type="submit">Save Valve Relay Module</button>
            </form>
            <button onclick="loadSettings()">Rescan USB Devices</button>
        </div>

        <!-- Valve Relay Port Assignments -->
        <div class="data-container">
            <h3>Valve Relay Port Assignments</h3>
            <form id="relay-port-form">
                <label for="feed-water-relay-port">Feed Water Relay Port:</label>
                <select id="feed-water-relay-port" class="relay-port-select">
                    <option value="1">Relay 1</option>
                    <option value="2">Relay 2</option>
                </select>
                <br><br>
                <label for="fresh-water-relay-port">Fresh Water Relay Port:</label>
                <select id="fresh-water-relay-port" class="relay-port-select">
                    <option value="1">Relay 1</option>
                    <option value="2">Relay 2</option>
                </select>
                <br><br>
                <button type="submit">Save Relay Port Assignments</button>
            </form>
        </div>

        <!-- Relay Testing -->
        <div class="data-container">
            <h3>Relay Testing</h3>
            <div>
                <p>Relay 1:</p>
                <button class="small-btn" onclick="turnOnRelay(1)">On</button>
                <button class="small-btn" onclick="turnOffRelay(1)">Off</button>
            </div>
            <div>
                <p>Relay 2:</p>
                <button class="small-btn" onclick="turnOnRelay(2)">On</button>
                <button class="small-btn" onclick="turnOffRelay(2)">Off</button>
            </div>
        </div>

        <!-- Add more sections as needed for other settings -->

    </main>
</body>
</html>