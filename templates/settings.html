<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Settings - Flow Meter Monitor</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/style.css">
    <link rel="manifest" href="/static/manifest.json">
    <style>
        .calibration-row {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        .calibration-row label {
            width: 120px;
            margin-right: 10px;
        }
        .calibration-row input {
            flex: 1;
        }
    </style>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            loadSettings();
        });

        function loadSettings() {
            fetch('/api/settings')
                .then(response => response.json())
                .then(data => {
                    const plantsList = document.getElementById('additional-plants-list');
                    plantsList.innerHTML = '';
                    data.additional_plants.forEach((plant, index) => {
                        const div = document.createElement('div');
                        div.className = 'valve-rename-cell';
                        div.innerHTML = `
                            <input type="text" value="${plant}" disabled>
                            <button class="small-btn secondary-btn" onclick="removePlant(${index})">Remove</button>
                        `;
                        plantsList.appendChild(div);
                    });

                    data.calibration_factors = data.calibration_factors || {};
                    document.getElementById('fresh-cal').value = data.calibration_factors.fresh || 28.390575;
                    document.getElementById('feed-cal').value = data.calibration_factors.feed || 28.390575;
                    document.getElementById('drain-cal').value = data.calibration_factors.drain || 28.390575;

                    // Load relay ports
                    const relayPorts = data.relay_ports || { feed_water: 1, fresh_water: 2 };
                    document.getElementById('feed-water-relay-port').value = relayPorts.feed_water;
                    document.getElementById('fresh-water-relay-port').value = relayPorts.fresh_water;

                    // Load USB roles and populate select
                    data.usb_roles = data.usb_roles || {};
                    populateUsbSelect(data);
                })
                .catch(error => console.error('Error loading settings:', error));
        }

        function populateUsbSelect(settingsData) {
            fetch('/api/settings/usb_devices')
                .then(response => response.json())
                .then(devices => {
                    const valveDevSelect = document.getElementById('valve-relay-device');
                    valveDevSelect.innerHTML = '<option value="">Select a device</option>';
                    devices.forEach(dev => {
                        const option = document.createElement('option');
                        option.value = dev.device;
                        option.textContent = dev.device;
                        if (option.value === settingsData.usb_roles.valve_relay) {
                            option.selected = true;
                        }
                        valveDevSelect.appendChild(option);
                    });
                })
                .catch(error => console.error('Error fetching USB devices:', error));
        }

        function addAdditionalPlant() {
            const newIp = document.getElementById('new-plant-ip').value.trim();
            if (!newIp) {
                alert('Please enter a valid IP or DNS.');
                return;
            }

            fetch('/api/settings', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ additional_plants: [newIp] })  // Send as array to append
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        document.getElementById('new-plant-ip').value = '';
                        loadSettings();
                    } else {
                        alert('Failed to add plant: ' + data.error);
                    }
                })
                .catch(error => console.error('Error adding plant:', error));
        }

        function removePlant(index) {
            fetch('/api/settings/remove_plant', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ index: index })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        loadSettings();
                    } else {
                        alert('Failed to remove plant: ' + data.error);
                    }
                })
                .catch(error => console.error('Error removing plant:', error));
        }

        function saveCalibrationFactors() {
            const fresh = parseFloat(document.getElementById('fresh-cal').value);
            const feed = parseFloat(document.getElementById('feed-cal').value);
            const drain = parseFloat(document.getElementById('drain-cal').value);

            if (isNaN(fresh) || isNaN(feed) || isNaN(drain)) {
                alert('Please enter valid numbers for all calibration factors.');
                return;
            }

            fetch('/api/settings', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ calibration_factors: { fresh, feed, drain } })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        alert('Calibration factors saved successfully.');
                        loadSettings();  // Reload to confirm
                    } else {
                        alert('Failed to save calibration factors: ' + data.error);
                    }
                })
                .catch(error => console.error('Error saving calibration factors:', error));
        }

        document.getElementById('valve-relay-form').addEventListener('submit', e => {
            e.preventDefault();
            const dev = document.getElementById('valve-relay-device').value;
            fetch("/api/settings/assign_usb", {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ role: 'valve_relay', device: dev })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        alert('Valve relay assigned successfully.');
                        loadSettings();
                    } else {
                        alert('Failed to assign valve relay: ' + data.error);
                    }
                })
                .catch(error => console.error('Error assigning valve relay:', error));
        });

        document.getElementById('relay-port-form').addEventListener('submit', e => {
            e.preventDefault();
            const feedPort = parseInt(document.getElementById('feed-water-relay-port').value, 10);
            const freshPort = parseInt(document.getElementById('fresh-water-relay-port').value, 10);
            fetch('/api/settings', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ relay_ports: { feed_water: feedPort, fresh_water: freshPort } })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        alert('Relay ports saved successfully.');
                        loadSettings();
                    } else {
                        alert('Failed to save relay ports: ' + data.error);
                    }
                })
                .catch(error => console.error('Error saving relay ports:', error));
        });
    </script>
</body>
</html>