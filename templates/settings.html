<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Settings - Flow Meter Monitor</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/style.css">
    <link rel="manifest" href="/static/manifest.json">
    <style>
        .calibration-row {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        .calibration-row label {
            width: 120px;
            margin-right: 10px;
        }
        .calibration-row input {
            flex: 1;
        }
    </style>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            loadSettings();
            fetchUsbDevices(); // Add this to load USB devices
        });

        function loadSettings() {
            fetch('/api/settings')
                .then(response => response.json())
                .then(data => {
                    const plantsList = document.getElementById('additional-plants-list');
                    plantsList.innerHTML = '';
                    data.additional_plants.forEach((plant, index) => {
                        const div = document.createElement('div');
                        div.className = 'valve-rename-cell';
                        div.innerHTML = `
                            <input type="text" value="${plant}" disabled>
                            <button class="small-btn secondary-btn" onclick="removePlant(${index})">Remove</button>
                        `;
                        plantsList.appendChild(div);
                    });

                    data.calibration_factors = data.calibration_factors || {};
                    document.getElementById('fresh-cal').value = data.calibration_factors.fresh || 28.390575;
                    document.getElementById('feed-cal').value = data.calibration_factors.feed || 28.390575;
                    document.getElementById('drain-cal').value = data.calibration_factors.drain || 28.390575;

                    // Load relay ports
                    const relayPorts = data.relay_ports || { feed_water: 1, fresh_water: 2 };
                    document.getElementById('feed-water-relay-port').value = relayPorts.feed_water;
                    document.getElementById('fresh-water-relay-port').value = relayPorts.fresh_water;
                })
                .catch(error => console.error('Error loading settings:', error));
        }

        function addAdditionalPlant() {
            const newIp = document.getElementById('new-plant-ip').value.trim();
            if (!newIp) {
                alert('Please enter a valid IP or DNS.');
                return;
            }

            fetch('/api/settings', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ additional_plants: [newIp] })  // Send as array to append
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        document.getElementById('new-plant-ip').value = '';
                        loadSettings();
                    } else {
                        alert('Failed to add plant: ' + data.error);
                    }
                })
                .catch(error => console.error('Error adding plant:', error));
        }

        function removePlant(index) {
            fetch('/api/settings/remove_plant', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ index: index })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        loadSettings();
                    } else {
                        alert('Failed to remove plant: ' + data.error);
                    }
                })
                .catch(error => console.error('Error removing plant:', error));
        }

        function saveCalibrationFactors() {
            const fresh = parseFloat(document.getElementById('fresh-cal').value);
            const feed = parseFloat(document.getElementById('feed-cal').value);
            const drain = parseFloat(document.getElementById('drain-cal').value);

            if (isNaN(fresh) || isNaN(feed) || isNaN(drain)) {
                alert('Please enter valid numbers for all calibration factors.');
                return;
            }

            fetch('/api/settings', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ calibration_factors: { fresh, feed, drain } })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        alert('Calibration factors saved successfully.');
                        loadSettings();  // Reload to confirm
                    } else {
                        alert('Failed to save calibration factors: ' + data.error);
                    }
                })
                .catch(error => console.error('Error saving calibration factors:', error));
        }

        function fetchUsbDevices() {
            fetch('/api/settings/usb_devices')
                .then(response => response.json())
                .then(devices => {
                    const dosingDevSelect = document.getElementById('dosing-relay-device');
                    dosingDevSelect.innerHTML = '<option value="">Select a device</option>';
                    devices.forEach(dev => {
                        const option = document.createElement('option');
                        option.value = dev.device;
                        option.textContent = dev.device;
                        dosingDevSelect.appendChild(option);
                    });
                })
                .catch(error => console.error('Error fetching USB devices:', error));
        }

        function saveUsbAssignment(role, device) {
            fetch("/api/settings/assign_usb", {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ role, device })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        alert(`${role} assigned successfully.`);
                    } else {
                        alert(`Failed to assign ${role}: ${data.error}`);
                    }
                })
                .catch(error => console.error(`Error assigning ${role}:`, error));
        }
    </script>
</head>
<body>
    <nav>
        <ul>
            <li><a href="/" class="active">Home</a></li>
            <li><a href="/settings" class="active">Settings</a></li>
            <li><a href="/debug" class="active">Debug</a></li>
            <li><a href="/logs">Logs</a></li>
        </ul>
    </nav>

    <main>
        <h1>Settings</h1>
        <p class="subtitle">Configure your flow meter monitor.</p>

        <div class="data-container">
            <h3>Plants to feed</h3>
            <div id="additional-plants-list">
                <!-- Populated by JS -->
            </div>
            <p>New IP / DNS:</p>
            <div class="valve-rename-cell">
                <input type="text" id="new-plant-ip" placeholder="e.g., 192.168.1.100 or plant2.local">
                <button class="small-btn" onclick="addAdditionalPlant()">+ Add</button>
            </div>
        </div>

        <div class="data-container">
            <h3>Flow Meter Calibration (pulses per gallon)</h3>
            <div class="calibration-row">
                <label>Fresh Water:</label>
                <input type="number" id="fresh-cal" step="0.001">
            </div>
            <div class="calibration-row">
                <label>Feed Water:</label>
                <input type="number" id="feed-cal" step="0.001">
            </div>
            <div class="calibration-row">
                <label>Drain:</label>
                <input type="number" id="drain-cal" step="0.001">
            </div>
            <button class="small-btn" onclick="saveCalibrationFactors()">Save Calibration Factors</button>
        </div>

        <!-- Dosing Relay Module Form -->
        <div class="data-container">
            <h3>Dosing Relay Module</h3>
            <form id="dosing-relay-form">
                <label for="dosing-relay-device">Dosing Relay Module:</label>
                <select id="dosing-relay-device" name="dosing-relay-device">
                    <option value="">Select a device</option>
                </select>
                <button type="submit">Save Dosing Relay Module</button>
            </form>
            <button onclick="fetchUsbDevices()">Rescan USB Devices</button>
        </div>

        <!-- Dosing Relay Port Assignments -->
        <div class="data-container">
            <h3>Dosing Relay Port Assignments</h3>
            <form id="relay-port-form">
                <label for="feed-water-relay-port">Feed Water Relay Port:</label>
                <select id="feed-water-relay-port">
                    <option value="1">Relay 1</option>
                    <option value="2">Relay 2</option>
                </select>
                <br><br>
                <label for="fresh-water-relay-port">Fresh Water Relay Port:</label>
                <select id="fresh-water-relay-port">
                    <option value="1">Relay 1</option>
                    <option value="2">Relay 2</option>
                </select>
                <br><br>
                <button type="submit">Save Relay Port Assignments</button>
            </form>
        </div>

        <!-- Add more sections as needed for other settings -->

    </main>
</body>
</html>