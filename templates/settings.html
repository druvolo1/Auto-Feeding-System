<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Settings - Flow Meter Monitor</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/style.css">
    <link rel="manifest" href="/static/manifest.json">
    <style>
        .calibration-row {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        .calibration-row label {
            width: 150px;
            margin-right: 10px;
        }
        .calibration-row input {
            flex: 1;
            min-width: 150px;
            padding: 5px;
        }
        .relay-port-select {
            width: 100px;
        }
        .relay-sections {
            display: flex;
            justify-content: space-between;
            flex: 0 1 800px;
            gap: 20px;
        }
        .relay-assignments {
            width: 60%;
        }
        .relay-testing {
            width: 35%;
        }
        .relay-button.active {
            background-color: green;
            color: white;
        }
        main {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }
        .data-container {
            flex: 0 1 400px;
            box-sizing: border-box;
        }
        h1, .subtitle {
            flex: 0 0 100%;
        }
        .feed-pump-options {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        .feed-pump-options input[type="radio"] {
            margin-right: 5px;
        }
        .feed-pump-options label {
            margin-right: 15px;
        }
        .tooltip {
            margin-left: 10px;
            font-size: 0.8em;
            color: #888;
        }
    </style>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            loadSettings();

            // Handle USB assignment form submit
            const valveForm = document.getElementById('valve-relay-form');
            if (valveForm) {
                valveForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    const device = document.getElementById('valve-relay-device')?.value;
                    if (device) {
                        saveUsbAssignment('valve_relay', device);
                    } else {
                        alert('Please select a device.');
                    }
                });
            }

            // Handle relay ports form submit
            const relayPortForm = document.getElementById('relay-port-form');
            if (relayPortForm) {
                relayPortForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    const feedPort = parseInt(document.getElementById('feed-water-relay-port')?.value, 10);
                    const freshPort = parseInt(document.getElementById('fresh-water-relay-port')?.value, 10);
                    if (!isNaN(feedPort) && !isNaN(freshPort)) {
                        fetch('/api/settings', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ relay_ports: { feed_water: feedPort, fresh_water: freshPort } })
                        })
                            .then(response => response.json())
                            .then(data => {
                                if (data.status === 'success') {
                                    alert('Relay ports saved successfully.');
                                    loadSettings();
                                } else {
                                    alert('Failed to save relay ports: ' + data.error);
                                }
                            })
                            .catch(error => console.error('Error saving relay ports:', error));
                    } else {
                        alert('Please select valid ports.');
                    }
                });
            }

            // Handle feed pump form submit
            const feedPumpForm = document.getElementById('feed-pump-form');
            if (feedPumpForm) {
                feedPumpForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    const ip = document.getElementById('feed-pump-ip')?.value.trim();
                    const ioNumber = document.getElementById('feed-pump-io-number')?.value.trim();
                    const isIO = document.getElementById('feed-pump-io')?.checked;
                    const isShelly = document.getElementById('feed-pump-shelly')?.checked;

                    if (isIO && ioNumber) {
                        fetch('/api/settings', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ feed_pump: { io_number: ioNumber, type: 'io' } })
                        })
                            .then(response => response.json())
                            .then(data => {
                                if (data.status === 'success') {
                                    alert('Feed pump settings saved successfully.');
                                    loadSettings();
                                } else {
                                    alert('Failed to save feed pump settings: ' + data.error);
                                }
                            })
                            .catch(error => console.error('Error saving feed pump settings:', error));
                    } else if (isShelly && ip) {
                        fetch('/api/settings', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ feed_pump: { ip: ip, type: 'shelly' } })
                        })
                            .then(response => response.json())
                            .then(data => {
                                if (data.status === 'success') {
                                    alert('Feed pump settings saved successfully.');
                                    loadSettings();
                                } else {
                                    alert('Failed to save feed pump settings: ' + data.error);
                                }
                            })
                            .catch(error => console.error('Error saving feed pump settings:', error));
                    } else {
                        alert('Please select a mode and provide a valid IO number or IP address.');
                    }
                });
            }

            // Handle feed pump mode toggle
            const ioRadio = document.getElementById('feed-pump-io');
            const shellyRadio = document.getElementById('feed-pump-shelly');
            const ipInput = document.getElementById('feed-pump-ip');
            const ioNumberInput = document.getElementById('feed-pump-io-number');
            if (ioRadio && shellyRadio && ipInput && ioNumberInput) {
                ioRadio.addEventListener('change', function() {
                    if (ioRadio.checked) {
                        ipInput.disabled = true;
                        ipInput.value = '';
                        ioNumberInput.disabled = false;
                    }
                });
                shellyRadio.addEventListener('change', function() {
                    if (shellyRadio.checked) {
                        ioNumberInput.disabled = true;
                        ioNumberInput.value = '';
                        ipInput.disabled = false;
                    }
                });
            }

            // Handle feed pump on/off buttons with debounce
            let lastClickTime = 0;
            const debounceTime = 500;

            const feedPumpOnButton = document.getElementById('feed-pump-on');
            if (feedPumpOnButton) {
                feedPumpOnButton.addEventListener('click', function(e) {
                    const now = Date.now();
                    if (now - lastClickTime < debounceTime) return;
                    lastClickTime = now;
                    turnOnFeedPump();
                });
            }

            const feedPumpOffButton = document.getElementById('feed-pump-off');
            if (feedPumpOffButton) {
                feedPumpOffButton.addEventListener('click', function(e) {
                    const now = Date.now();
                    if (now - lastClickTime < debounceTime) return;
                    lastClickTime = now;
                    turnOffFeedPump();
                });
            }

            // Handle drain flow settings form submit
            const drainFlowForm = document.getElementById('drain-flow-form');
            if (drainFlowForm) {
                drainFlowForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    const activationFlow = parseFloat(document.getElementById('activation-flow-rate')?.value);
                    const minFlow = parseFloat(document.getElementById('min-flow-rate')?.value);
                    const activationDelay = parseInt(document.getElementById('activation-delay')?.value, 10);
                    const minFlowCheckDelay = parseInt(document.getElementById('min-flow-check-delay')?.value, 10);
                    const maxDrainTime = parseInt(document.getElementById('max-drain-time')?.value, 10);

                    if (isNaN(activationFlow) || isNaN(minFlow) || isNaN(activationDelay) || isNaN(minFlowCheckDelay) || isNaN(maxDrainTime)) {
                        alert('Please enter valid numbers for all drain flow settings.');
                        return;
                    }
                    if (minFlow >= activationFlow) {
                        alert('Minimum flow rate must be less than activation flow rate.');
                        return;
                    }
                    if (maxDrainTime <= 0) {
                        alert('Max drain time must be greater than 0.');
                        return;
                    }

                    fetch('/api/settings', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            drain_flow_settings: {
                                activation_flow_rate: activationFlow,
                                min_flow_rate: minFlow,
                                activation_delay: activationDelay,
                                min_flow_check_delay: minFlowCheckDelay,
                                max_drain_time: maxDrainTime
                            }
                        })
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.status === 'success') {
                                alert('Drain flow settings saved successfully.');
                                loadSettings();
                            } else {
                                alert('Failed to save drain flow settings: ' + data.error);
                            }
                        })
                        .catch(error => console.error('Error saving drain flow settings:', error));
                });
            }

            // Handle Discord settings form submit
            const discordForm = document.getElementById('discord-form');
            if (discordForm) {
                discordForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    const discordEnabled = document.getElementById('discord-enabled')?.checked;
                    const discordWebhookUrl = document.getElementById('discord-webhook-url')?.value.trim();
                    fetch('/api/settings', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            discord_enabled: discordEnabled,
                            discord_webhook_url: discordWebhookUrl
                        })
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.status === 'success') {
                                alert('Discord settings saved successfully.');
                                loadSettings();
                            } else {
                                alert('Failed to save Discord settings: ' + data.error);
                            }
                        })
                        .catch(error => console.error('Error saving Discord settings:', error));
                });
            }

            // Handle Discord test message
            const discordTestForm = document.getElementById('discord-test-form');
            if (discordTestForm) {
                discordTestForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    const testMessage = document.getElementById('discord-test-message')?.value.trim();
                    if (!testMessage) {
                        alert('Please enter a test message.');
                        return;
                    }
                    fetch('/api/settings/discord_message', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ test_message: testMessage })
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.status === 'success') {
                                alert('Test Discord message sent successfully: ' + data.info);
                            } else {
                                alert('Failed to send test Discord message: ' + data.error);
                            }
                        })
                        .catch(error => console.error('Error sending test Discord message:', error));
                });
            }

            // Handle Telegram settings form submit
            const telegramForm = document.getElementById('telegram-form');
            if (telegramForm) {
                telegramForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    const telegramEnabled = document.getElementById('telegram-enabled')?.checked;
                    const telegramBotToken = document.getElementById('telegram-bot-token')?.value.trim();
                    const telegramChatId = document.getElementById('telegram-chat-id')?.value.trim();
                    fetch('/api/settings', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            telegram_enabled: telegramEnabled,
                            telegram_bot_token: telegramBotToken,
                            telegram_chat_id: telegramChatId
                        })
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.status === 'success') {
                                alert('Telegram settings saved successfully.');
                                loadSettings();
                            } else {
                                alert('Failed to save Telegram settings: ' + data.error);
                            }
                        })
                        .catch(error => console.error('Error saving Telegram settings:', error));
                });
            }

            // Handle Telegram test message
            const telegramTestForm = document.getElementById('telegram-test-form');
            if (telegramTestForm) {
                telegramTestForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    const testMessage = document.getElementById('telegram-test-message')?.value.trim();
                    if (!testMessage) {
                        alert('Please enter a test message.');
                        return;
                    }
                    fetch('/api/settings/telegram_message', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ test_message: testMessage })
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.status === 'success') {
                                alert('Test Telegram message sent successfully: ' + data.info);
                            } else {
                                alert('Failed to send test Telegram message: ' + data.error);
                            }
                        })
                        .catch(error => console.error('Error sending test Telegram message:', error));
                });
            }
        });

        // Function to check for updates
        function checkForUpdate() {
            document.getElementById('update-status').innerText = 'Checking...';
            fetch('/api/settings/check_update')
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        if (data.update_available) {
                            document.getElementById('update-status').innerText = 'Update available';
                            if (confirm('An update is available. Do you want to apply it?')) {
                                applyUpdate();
                            }
                        } else {
                            document.getElementById('update-status').innerText = 'No update available';
                        }
                    } else {
                        document.getElementById('update-status').innerText = 'Error: ' + data.error;
                    }
                })
                .catch(error => {
                    document.getElementById('update-status').innerText = 'Error checking for update';
                    console.error('Error:', error);
                });
        }

        // Function to apply update
        function applyUpdate() {
            const modal = document.getElementById('update-modal');
            const progress = document.getElementById('update-progress');
            const title = document.getElementById('update-title');
            const overlay = document.getElementById('overlay');
            const closeBtn = document.getElementById('close-modal');

            modal.style.display = 'block';
            overlay.style.display = 'block';
            closeBtn.style.display = 'none';
            title.textContent = 'Applying update...';
            progress.textContent = 'Please wait...';

            fetch('/api/settings/apply_update', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        progress.textContent = 'Update complete. The application will restart.';
                        title.textContent = 'Update Successful!';
                        closeBtn.style.display = 'inline-block';
                        closeBtn.textContent = 'Close & Reload';
                    } else {
                        progress.textContent = 'Update failed: ' + data.error;
                        title.textContent = 'Update Failed';
                        closeBtn.style.display = 'inline-block';
                        closeBtn.textContent = 'Close';
                    }
                })
                .catch(error => {
                    progress.textContent = 'Error applying update: ' + error;
                    title.textContent = 'Update Error';
                    closeBtn.style.display = 'inline-block';
                    closeBtn.textContent = 'Close';
                });
        }

        // Function to close modal
        function closeUpdateModal() {
            const modal = document.getElementById('update-modal');
            const overlay = document.getElementById('overlay');
            if (document.getElementById('update-title').textContent === 'Update Successful!') {
                modal.style.display = 'none';
                overlay.style.display = 'none';
                setTimeout(() => {
                    window.location.href = window.location.href; // Force reload after modal closes
                }, 100); // Brief delay to ensure modal hides first
            } else {
                modal.style.display = 'none';
                overlay.style.display = 'none';
            }
        }

        function loadSettings() {
            fetch('/api/settings')
                .then(response => response.json())
                .then(data => {
                    const plantsList = document.getElementById('additional-plants-list');
                    if (plantsList) {
                        plantsList.innerHTML = '';
                        data.additional_plants.forEach((plant, index) => {
                            const div = document.createElement('div');
                            div.className = 'valve-rename-cell';
                            div.innerHTML = `
                                <input type="text" value="${plant}" disabled>
                                <button class="small-btn secondary-btn" onclick="removePlant(${index})">Remove</button>
                            `;
                            plantsList.appendChild(div);
                        });
                    }

                    data.calibration_factors = data.calibration_factors || {};
                    const freshCal = document.getElementById('fresh-cal');
                    if (freshCal) freshCal.value = data.calibration_factors.fresh || 28.390575;
                    const feedCal = document.getElementById('feed-cal');
                    if (feedCal) feedCal.value = data.calibration_factors.feed || 28.390575;
                    const drainCal = document.getElementById('drain-cal');
                    if (drainCal) drainCal.value = data.calibration_factors.drain || 28.390575;

                    const relayPorts = data.relay_ports || { feed_water: 1, fresh_water: 2 };
                    const feedPortEl = document.getElementById('feed-water-relay-port');
                    if (feedPortEl) feedPortEl.value = relayPorts.feed_water;
                    const freshPortEl = document.getElementById('fresh-water-relay-port');
                    if (freshPortEl) freshPortEl.value = relayPorts.fresh_water;

                    const nutrientConcEl = document.getElementById('nutrient-conc');
                    if (nutrientConcEl) nutrientConcEl.value = data.nutrient_concentration ?? 1;

                    const usbRoles = data.usb_roles || {};
                    populateUsbDevices(usbRoles.valve_relay);

                    loadRelayStatuses();

                    const feedPumpIp = document.getElementById('feed-pump-ip');
                    const feedPumpIoNumber = document.getElementById('feed-pump-io-number');
                    const feedPumpIo = document.getElementById('feed-pump-io');
                    const feedPumpShelly = document.getElementById('feed-pump-shelly');
                    if (feedPumpIp && feedPumpIoNumber && feedPumpIo && feedPumpShelly) {
                        const feedPump = data.feed_pump || {};
                        feedPumpIp.value = feedPump.ip || '';
                        feedPumpIoNumber.value = feedPump.io_number || '';
                        feedPumpIo.checked = feedPump.type === 'io';
                        feedPumpShelly.checked = feedPump.type === 'shelly';
                        if (feedPumpIo.checked) {
                            feedPumpIp.disabled = true;
                            feedPumpIoNumber.disabled = false;
                        } else if (feedPumpShelly.checked) {
                            feedPumpIoNumber.disabled = true;
                            feedPumpIp.disabled = false;
                        } else {
                            feedPumpIp.disabled = true;
                            feedPumpIoNumber.disabled = true;
                        }
                    }

                    const drainFlowSettings = data.drain_flow_settings || {};
                    const activationFlow = document.getElementById('activation-flow-rate');
                    if (activationFlow) activationFlow.value = drainFlowSettings.activation_flow_rate !== undefined ? drainFlowSettings.activation_flow_rate : 0.2;
                    const minFlow = document.getElementById('min-flow-rate');
                    if (minFlow) minFlow.value = drainFlowSettings.min_flow_rate !== undefined ? drainFlowSettings.min_flow_rate : 0.05;
                    const activationDelay = document.getElementById('activation-delay');
                    if (activationDelay) activationDelay.value = drainFlowSettings.activation_delay !== undefined ? drainFlowSettings.activation_delay : 5;
                    const minFlowCheckDelay = document.getElementById('min-flow-check-delay');
                    if (minFlowCheckDelay) minFlowCheckDelay.value = drainFlowSettings.min_flow_check_delay !== undefined ? drainFlowSettings.min_flow_check_delay : 30;
                    const maxDrainTime = document.getElementById('max-drain-time');
                    if (maxDrainTime) maxDrainTime.value = drainFlowSettings.max_drain_time !== undefined ? drainFlowSettings.max_drain_time : 600;

                    const discordEnabled = document.getElementById('discord-enabled');
                    if (discordEnabled) discordEnabled.checked = data.discord_enabled || false;
                    const discordWebhookUrl = document.getElementById('discord-webhook-url');
                    if (discordWebhookUrl) discordWebhookUrl.value = data.discord_webhook_url || '';
                    const telegramEnabled = document.getElementById('telegram-enabled');
                    if (telegramEnabled) telegramEnabled.checked = data.telegram_enabled || false;
                    const telegramBotToken = document.getElementById('telegram-bot-token');
                    if (telegramBotToken) telegramBotToken.value = data.telegram_bot_token || '';
                    const telegramChatId = document.getElementById('telegram-chat-id');
                    if (telegramChatId) telegramChatId.value = data.telegram_chat_id || '';

                    const currentVersionEl = document.getElementById('current-version');
                    if (currentVersionEl) currentVersionEl.textContent = data.current_version || 'Unknown';
                })
                .catch(error => console.error('Error loading settings:', error));
        }

        function populateUsbDevices(currentDevice) {
            fetch('/api/settings/usb_devices')
                .then(response => response.json())
                .then(devices => {
                    const valveDevSelect = document.getElementById('valve-relay-device');
                    if (valveDevSelect) {
                        valveDevSelect.innerHTML = '<option value="">Select a device</option>';
                        devices.forEach(dev => {
                            const option = document.createElement('option');
                            option.value = dev.device;
                            option.textContent = dev.device;
                            if (option.value === currentDevice) {
                                option.selected = true;
                            }
                            valveDevSelect.appendChild(option);
                        });
                    }
                })
                .catch(error => console.error('Error fetching USB devices:', error));
        }

        function addAdditionalPlant() {
            const newIp = document.getElementById('new-plant-ip')?.value.trim();
            if (!newIp) {
                alert('Please enter a valid IP or DNS.');
                return;
            }

            fetch('/api/settings', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ additional_plants: [newIp] })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        document.getElementById('new-plant-ip').value = '';
                        loadSettings();
                    } else {
                        alert('Failed to add plant: ' + data.error);
                    }
                })
                .catch(error => console.error('Error adding plant:', error));
        }

        function removePlant(index) {
            fetch('/api/settings/remove_plant', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ index: index })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        loadSettings();
                    } else {
                        alert('Failed to remove plant: ' + data.error);
                    }
                })
                .catch(error => console.error('Error removing plant:', error));
        }

        function saveCalibrationFactors() {
            const fresh = parseFloat(document.getElementById('fresh-cal')?.value);
            const feed = parseFloat(document.getElementById('feed-cal')?.value);
            const drain = parseFloat(document.getElementById('drain-cal')?.value);

            if (isNaN(fresh) || isNaN(feed) || isNaN(drain)) {
                alert('Please enter valid numbers for all calibration factors.');
                return;
            }

            fetch('/api/settings', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ calibration_factors: { fresh, feed, drain } })
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.status === 'success') {
                        alert('Calibration factors saved successfully.');
                        loadSettings();
                    } else {
                        alert('Failed to save calibration factors: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error saving calibration factors:', error);
                    alert('Failed to save: ' + error.message);
                });
        }

        function saveNutrientConcentration() {
            const concentration = parseFloat(document.getElementById('nutrient-conc')?.value);

            if (isNaN(concentration)) {
                alert('Please enter a valid number for nutrient concentration.');
                return;
            }

            fetch('/api/settings', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ nutrient_concentration: concentration })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        alert('Nutrient concentration saved successfully.');
                        loadSettings();
                    } else {
                        alert('Failed to save nutrient concentration: ' + data.error);
                    }
                })
                .catch(error => console.error('Error saving nutrient concentration:', error));
        }

        function saveUsbAssignment(role, device) {
            fetch("/api/settings/assign_usb", {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ role, device })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        alert(`${role} assigned successfully.`);
                        loadSettings();
                    } else {
                        alert(`Failed to assign ${role}: ${data.error}`);
                    }
                })
                .catch(error => console.error(`Error assigning ${role}:`, error));
        }

        function turnOnRelay(relayId) {
            fetch(`/api/valve_relay/${relayId}/on`, { 
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        updateRelayButton(relayId, 'on');
                    } else {
                        console.error(`Failed to turn on relay ${relayId}: ${data.error}`);
                    }
                })
                .catch(error => console.error(`Error turning on relay ${relayId}:`, error));
        }

        function turnOffRelay(relayId) {
            fetch(`/api/valve_relay/${relayId}/off`, { 
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        updateRelayButton(relayId, 'off');
                    } else {
                        console.error(`Failed to turn off relay ${relayId}: ${data.error}`);
                    }
                })
                .catch(error => console.error(`Error turning off relay ${relayId}:`, error));
        }

        function loadRelayStatuses() {
            [1, 2].forEach(relayId => {
                fetch(`/api/valve_relay/${relayId}/status`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            updateRelayButton(relayId, data.relay_status);
                        }
                    })
                    .catch(error => console.error(`Error fetching status for relay ${relayId}:`, error));
            });
        }

        function updateRelayButton(relayId, status) {
            const onButton = document.getElementById(`relay-${relayId}-on`);
            const offButton = document.getElementById(`relay-${relayId}-off`);
            if (status === 'on') {
                onButton.classList.add('active');
                offButton.classList.remove('active');
            } else {
                onButton.classList.remove('active');
                offButton.classList.add('active');
            }
        }

        function turnOnFeedPump() {
            fetch('/api/feed_pump/on', { method: 'POST', headers: { 'Content-Type': 'application/json' } })
                .then(response => response.json())
                .then(data => {
                    if (data.status !== 'success') {
                        console.error('Failed to turn on feed pump:', data.error);
                    } else {
                        updateFeedPumpButton('on');
                    }
                })
                .catch(error => console.error('Error turning on feed pump:', error));
        }

        function turnOffFeedPump() {
            fetch('/api/feed_pump/off', { method: 'POST', headers: { 'Content-Type': 'application/json' } })
                .then(response => response.json())
                .then(data => {
                    if (data.status !== 'success') {
                        console.error('Failed to turn off feed pump:', data.error);
                    } else {
                        updateFeedPumpButton('off');
                    }
                })
                .catch(error => console.error('Error turning off feed pump:', error));
        }

        function updateFeedPumpButton(status) {
            const onButton = document.getElementById('feed-pump-on');
            const offButton = document.getElementById('feed-pump-off');
            if (onButton && offButton) {
                if (status === 'on') {
                    onButton.classList.add('active');
                    offButton.classList.remove('active');
                } else {
                    onButton.classList.remove('active');
                    offButton.classList.add('active');
                }
            }
        }
    </script>
</head>
<body>
    <nav>
        <ul>
            <li><a href="/">Home</a></li>
            <li><a href="/nutrient_calculator">Nutrient Calculator</a></li>
            <li><a href="/settings" class="active">Settings</a></li>
            <li><a href="/debug">Debug</a></li>
            <li><a href="/logs">Logs</a></li>
        </ul>
    </nav>

    <main>
        <!-- Progress Modal for Updates -->
        <div id="update-modal" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #333; color: #fff; padding: 20px; border: 1px solid #555; box-shadow: 0 4px 8px rgba(0,0,0,0.3); z-index: 1000; max-width: 80%; max-height: 80%; overflow-y: auto;">
            <h3 id="update-title">Updating Application...</h3>
            <div id="update-progress" style="margin: 10px 0; font-family: monospace; white-space: pre-wrap;"></div>
            <button id="close-modal" onclick="closeUpdateModal()" style="display: none;">Close</button>
        </div>
        <div id="overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 999;"></div>

        <h1>Settings</h1>
        <p class="subtitle">Configure your flow meter monitor.</p>

        <div class="data-container">
            <h3>Plants to feed</h3>
            <div id="additional-plants-list">
                <!-- Populated by JS -->
            </div>
            <p>New IP / DNS:</p>
            <div class="valve-rename-cell">
                <input type="text" id="new-plant-ip" placeholder="e.g., 192.168.1.100 or plant2.local">
                <button class="small-btn" onclick="addAdditionalPlant()">+ Add</button>
            </div>
        </div>

        <div class="data-container">
            <h3>Flow Meter Calibration (pulses per gallon)</h3>
            <div class="calibration-row">
                <label>Fresh Water:</label>
                <input type="number" id="fresh-cal" step="0.001">
            </div>
            <div class="calibration-row">
                <label>Feed Water:</label>
                <input type="number" id="feed-cal" step="0.001">
            </div>
            <div class="calibration-row">
                <label>Drain:</label>
                <input type="number" id="drain-cal" step="0.001">
            </div>
            <button class="small-btn" onclick="saveCalibrationFactors()">Save Calibration Factors</button>
        </div>

        <div class="data-container">
            <h3>Nutrient Concentration</h3>
            <div class="calibration-row">
                <label>Concentration:</label>
                <input type="number" id="nutrient-conc" step="0.1" value="1">
            </div>
            <button class="small-btn" onclick="saveNutrientConcentration()">Save Nutrient Concentration</button>
        </div>

        <div class="data-container">
            <h3>Valve Relay Module</h3>
            <form id="valve-relay-form">
                <label for="valve-relay-device">Valve Relay Module:</label>
                <select id="valve-relay-device" name="valve-relay-device">
                    <option value="">Select a device</option>
                </select>
                <br><br>
                <button type="submit">Save Valve Relay Module</button>
            </form>
            <br>
            <button onclick="loadSettings()">Rescan USB Devices</button>
        </div>

        <div class="relay-sections">
            <div class="relay-assignments data-container">
                <h3>Valve Relay Port Assignments</h3>
                <form id="relay-port-form">
                    <label for="feed-water-relay-port">Feed Water Relay Port:</label>
                    <select id="feed-water-relay-port" class="relay-port-select">
                        <option value="1">Relay 1</option>
                        <option value="2">Relay 2</option>
                    </select>
                    <br><br>
                    <label for="fresh-water-relay-port">Fresh Water Relay Port:</label>
                    <select id="fresh-water-relay-port" class="relay-port-select">
                        <option value="1">Relay 1</option>
                        <option value="2">Relay 2</option>
                    </select>
                    <br><br>
                    <button type="submit">Save Relay Port Assignments</button>
                </form>
            </div>

            <div class="relay-testing data-container">
                <h3>Relay Testing</h3>
                <p>Relay 1:</p>
                <button id="relay-1-on" class="small-btn relay-button" onclick="turnOnRelay(1)">On</button>
                <button id="relay-1-off" class="small-btn relay-button" onclick="turnOffRelay(1)">Off</button>
                <br><br>
                <p>Relay 2:</p>
                <button id="relay-2-on" class="small-btn relay-button" onclick="turnOnRelay(2)">On</button>
                <button id="relay-2-off" class="small-btn relay-button" onclick="turnOffRelay(2)">Off</button>
            </div>
        </div>

        <div class="data-container">
            <h3>Nutrient Feed Pump</h3>
            <form id="feed-pump-form">
                <div class="feed-pump-options">
                    <label>Pump Control Mode:</label>
                    <input type="radio" id="feed-pump-io" name="feed-pump-type" value="io">
                    <label for="feed-pump-io">IO</label>
                    <input type="radio" id="feed-pump-shelly" name="feed-pump-type" value="shelly">
                    <label for="feed-pump-shelly">Shelly</label>
                </div>
                <div class="calibration-row" id="io-settings">
                    <label>IO Number:</label>
                    <input type="number" id="feed-pump-io-number" placeholder="e.g., 17" min="0">
                </div>
                <div class="calibration-row" id="shelly-settings">
                    <label>IP Address:</label>
                    <input type="text" id="feed-pump-ip" placeholder="e.g., 192.168.1.100">
                </div>
                <button type="submit">Save Feed Pump Settings</button>
            </form>
            <br>
            <button id="feed-pump-on" class="small-btn relay-button" onclick="turnOnFeedPump()">On</button>
            <button id="feed-pump-off" class="small-btn relay-button" onclick="turnOffFeedPump()">Off</button>
        </div>

        <div class="data-container">
            <h3>Drain Flow Settings</h3>
            <form id="drain-flow-form">
                <div class="calibration-row">
                    <label>Activation Flow Rate (Gal/min):</label>
                    <input type="number" id="activation-flow-rate" step="0.01" min="0" value="0.2">
                    <span class="tooltip">Minimum flow to confirm draining has started.</span>
                </div>
                <div class="calibration-row">
                    <label>Minimum Flow Rate (Gal/min):</label>
                    <input type="number" id="min-flow-rate" step="0.01" min="0" value="0.05">
                    <span class="tooltip">Threshold below which draining is considered stalled.</span>
                </div>
                <div class="calibration-row">
                    <label>Activation Delay (seconds):</label>
                    <input type="number" id="activation-delay" step="1" min="0" value="5">
                    <span class="tooltip">Delay after flow exceeds activation before monitoring min flow.</span>
                </div>
                <div class="calibration-row">
                    <label>Min Flow Check Delay (seconds):</label>
                    <input type="number" id="min-flow-check-delay" step="1" min="0" value="30">
                    <span class="tooltip">Delay after flow drops below min before aborting drain.</span>
                </div>
                <div class="calibration-row">
                    <label>Max Drain Time (seconds):</label>
                    <input type="number" id="max-drain-time" step="1" min="1" value="600">
                    <span class="tooltip">Maximum time allowed for draining before timing out.</span>
                </div>
                <button class="small-btn" type="submit">Save Drain Flow Settings</button>
            </form>
        </div>

        <div class="data-container">
            <h3>Notifications</h3>
            <div>
                <h4>Discord Settings</h4>
                <form id="discord-form">
                    <div class="calibration-row">
                        <label>Enable Discord Notifications:</label>
                        <input type="checkbox" id="discord-enabled">
                    </div>
                    <div class="calibration-row">
                        <label>Discord Webhook URL:</label>
                        <input type="text" id="discord-webhook-url" placeholder="https://discord.com/api/webhooks/...">
                    </div>
                    <button type="submit">Save Discord Settings</button>
                </form>
                <br>
                <form id="discord-test-form">
                    <h4>Test Discord Notification</h4>
                    <div class="calibration-row">
                        <label>Test Message:</label>
                        <input type="text" id="discord-test-message" placeholder="Enter test message">
                    </div>
                    <button type="submit">Send Test</button>
                </form>
            </div>
            <div>
                <h4>Telegram Settings</h4>
                <form id="telegram-form">
                    <div class="calibration-row">
                        <label>Enable Telegram Notifications:</label>
                        <input type="checkbox" id="telegram-enabled">
                    </div>
                    <div class="calibration-row">
                        <label>Telegram Bot Token:</label>
                        <input type="text" id="telegram-bot-token" placeholder="Enter bot token">
                    </div>
                    <div class="calibration-row">
                        <label>Telegram Chat ID:</label>
                        <input type="text" id="telegram-chat-id" placeholder="Enter chat ID">
                    </div>
                    <button type="submit">Save Telegram Settings</button>
                </form>
                <br>
                <form id="telegram-test-form">
                    <h4>Test Telegram Notification</h4>
                    <div class="calibration-row">
                        <label>Test Message:</label>
                        <input type="text" id="telegram-test-message" placeholder="Enter test message">
                    </div>
                    <button type="submit">Send Test</button>
                </form>
            </div>
        </div>

        <div class="data-container">
            <h3>Application Update</h3>
            <p>Current Version: <span id="current-version">Unknown</span></p>
            <button class="small-btn" onclick="checkForUpdate()">Check for Update</button>
            <p id="update-status"></p>
        </div>
    </main>
</body>
</html>
